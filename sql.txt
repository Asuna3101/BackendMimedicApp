CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

CREATE TABLE IF NOT EXISTS usuarios (
    id INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    nombre VARCHAR(50) NOT NULL,
    fecha_nacimiento DATE,
    celular VARCHAR(20),
    correo VARCHAR(50) NOT NULL UNIQUE,
    password VARCHAR(200),
    hashed_password VARCHAR(200) NOT NULL,
    is_active BOOLEAN NOT NULL DEFAULT TRUE,
    is_superuser BOOLEAN NOT NULL DEFAULT FALSE,
    fecha_creacion TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMPTZ,
    CONSTRAINT chk_email_formato CHECK (
        correo ~* '^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}$'
    )
);

CREATE INDEX idx_usuarios_correo ON usuarios(correo);
CREATE INDEX idx_usuarios_is_active ON usuarios(is_active) WHERE is_active = TRUE;

CREATE TABLE IF NOT EXISTS medicamentos (
    id INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    nombre VARCHAR(100) NOT NULL UNIQUE,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMPTZ
);

CREATE INDEX idx_medicamentos_nombre ON medicamentos(nombre);

CREATE TABLE IF NOT EXISTS unidades (
    id INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    nombre VARCHAR(50) NOT NULL UNIQUE,
    abreviatura VARCHAR(10),
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE INDEX idx_unidades_nombre ON unidades(nombre);

CREATE TABLE IF NOT EXISTS medicamento_usuario (
    id INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    idusuario INT NOT NULL,
    idmedicamento INT NOT NULL,
    idunidad INT NOT NULL,
    dosis NUMERIC(10,2) NOT NULL,
    frecuencia_horas NUMERIC(5,2) NOT NULL,
    fecha_inicio TIMESTAMPTZ NOT NULL,
    fecha_fin TIMESTAMPTZ NOT NULL,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMPTZ,
    CONSTRAINT fk_medicamento_usuario_usuario
        FOREIGN KEY (idusuario) REFERENCES usuarios(id) ON DELETE CASCADE,
    CONSTRAINT fk_medicamento_usuario_medicamento
        FOREIGN KEY (idmedicamento) REFERENCES medicamentos(id) ON DELETE CASCADE,
    CONSTRAINT fk_medicamento_usuario_unidad
        FOREIGN KEY (idunidad) REFERENCES unidades(id) ON DELETE CASCADE,
    CONSTRAINT chk_dosis_positiva CHECK (dosis > 0),
    CONSTRAINT chk_frecuencia_positiva CHECK (frecuencia_horas > 0),
    CONSTRAINT chk_fechas_validas CHECK (fecha_fin > fecha_inicio)
);

CREATE INDEX idx_mu_idusuario ON medicamento_usuario(idusuario);
CREATE INDEX idx_mu_idmedicamento ON medicamento_usuario(idmedicamento);
CREATE INDEX idx_mu_fecha_fin ON medicamento_usuario(fecha_fin);

CREATE TABLE IF NOT EXISTS tomas (
    id INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    idmedxuser INT NOT NULL,
    tomado BOOLEAN NOT NULL DEFAULT FALSE,
    adquired TIMESTAMPTZ NOT NULL,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMPTZ,
    CONSTRAINT fk_tomas_medicamento_usuario
        FOREIGN KEY (idmedxuser) REFERENCES medicamento_usuario(id) ON DELETE CASCADE
);

CREATE INDEX idx_tomas_idmedxuser ON tomas(idmedxuser);
CREATE INDEX idx_tomas_adquired ON tomas(adquired);
CREATE INDEX idx_tomas_tomado_false ON tomas(tomado) WHERE tomado = FALSE;
CREATE INDEX idx_tomas_medxuser_fecha ON tomas(idmedxuser, adquired);

CREATE TABLE IF NOT EXISTS clinicas (
    id INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    nombre VARCHAR(120) NOT NULL,
    ciudad VARCHAR(80),
    direccion VARCHAR(200)
);

CREATE INDEX idx_clinicas_nombre ON clinicas(nombre);
CREATE INDEX idx_clinicas_ciudad ON clinicas(ciudad);

CREATE TABLE IF NOT EXISTS especialidades (
    id INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    nombre VARCHAR(100) NOT NULL
);

CREATE INDEX idx_especialidades_nombre ON especialidades(nombre);

CREATE TABLE IF NOT EXISTS doctores (
    id INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    nombre VARCHAR(120) NOT NULL,
    clinica_id INT NOT NULL,
    especialidad_id INT NOT NULL,
    CONSTRAINT fk_doctores_clinica
        FOREIGN KEY (clinica_id) REFERENCES clinicas(id) ON DELETE CASCADE,
    CONSTRAINT fk_doctores_especialidad
        FOREIGN KEY (especialidad_id) REFERENCES especialidades(id) ON DELETE CASCADE
);

CREATE INDEX idx_doctores_clinica_id ON doctores(clinica_id);
CREATE INDEX idx_doctores_especialidad_id ON doctores(especialidad_id);
CREATE INDEX idx_doctores_cli_esp ON doctores(clinica_id, especialidad_id);

CREATE TABLE IF NOT EXISTS clinic_specialty (
    id INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    clinic_id INT NOT NULL,
    specialty_id INT NOT NULL,
    CONSTRAINT fk_clinic_specialty_clinic
        FOREIGN KEY (clinic_id) REFERENCES clinicas(id) ON DELETE CASCADE,
    CONSTRAINT fk_clinic_specialty_specialty
        FOREIGN KEY (specialty_id) REFERENCES especialidades(id) ON DELETE CASCADE,
    CONSTRAINT uq_clinic_specialty UNIQUE (clinic_id, specialty_id)
);

CREATE INDEX idx_clinic_specialty_clinic ON clinic_specialty(clinic_id);
CREATE INDEX idx_clinic_specialty_specialty ON clinic_specialty(specialty_id);

CREATE TABLE IF NOT EXISTS appointment_reminders (
    id INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    user_id INT NOT NULL,
    clinic_id INT NOT NULL,
    specialty_id INT NOT NULL,
    doctor_id INT NOT NULL,
    starts_at TIMESTAMPTZ NOT NULL,
    notes VARCHAR(400),
    status VARCHAR(20) NOT NULL DEFAULT 'PENDIENTE',
    CONSTRAINT fk_appointment_user
        FOREIGN KEY (user_id) REFERENCES usuarios(id) ON DELETE CASCADE,
    CONSTRAINT fk_appointment_clinic
        FOREIGN KEY (clinic_id) REFERENCES clinicas(id) ON DELETE CASCADE,
    CONSTRAINT fk_appointment_specialty
        FOREIGN KEY (specialty_id) REFERENCES especialidades(id) ON DELETE CASCADE,
    CONSTRAINT fk_appointment_doctor
        FOREIGN KEY (doctor_id) REFERENCES doctores(id) ON DELETE CASCADE,
    CONSTRAINT chk_status_valido CHECK (
        status IN ('PENDIENTE', 'ASISTIDO', 'NO_ASISTIDO')
    ),
    CONSTRAINT uq_user_doctor_start UNIQUE (user_id, doctor_id, starts_at)
);

CREATE INDEX idx_appt_user_id ON appointment_reminders(user_id);
CREATE INDEX idx_appt_doctor_id ON appointment_reminders(doctor_id);
CREATE INDEX idx_appt_starts_at ON appointment_reminders(starts_at);
CREATE INDEX idx_appt_status ON appointment_reminders(status);
CREATE INDEX idx_appt_user_status ON appointment_reminders(user_id, status);
CREATE INDEX idx_appt_clinic_id ON appointment_reminders(clinic_id);

CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at := NOW();
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trg_usuarios_updated_at
    BEFORE UPDATE ON usuarios
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();

-- Nuevas columnas para perfil/recuperación
ALTER TABLE IF EXISTS usuarios
    ADD COLUMN IF NOT EXISTS photo_url VARCHAR(255);

ALTER TABLE IF EXISTS usuarios
    ADD COLUMN IF NOT EXISTS recovery_code VARCHAR(10),
    ADD COLUMN IF NOT EXISTS recovery_expires TIMESTAMPTZ;

CREATE TRIGGER trg_medicamentos_updated_at
    BEFORE UPDATE ON medicamentos
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER trg_medicamento_usuario_updated_at
    BEFORE UPDATE ON medicamento_usuario
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER trg_tomas_updated_at
    BEFORE UPDATE ON tomas
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();

CREATE OR REPLACE FUNCTION generate_tomas(p_medxuser_id INT)
RETURNS VOID AS $$
DECLARE
    v_fecha_actual TIMESTAMPTZ;
    v_fecha_fin TIMESTAMPTZ;
    v_frecuencia NUMERIC(5,2);
    v_delta INTERVAL;
BEGIN
    SELECT fecha_inicio, fecha_fin, frecuencia_horas
    INTO v_fecha_actual, v_fecha_fin, v_frecuencia
    FROM medicamento_usuario
    WHERE id = p_medxuser_id;

    v_delta := (v_frecuencia || ' hours')::INTERVAL;

    WHILE v_fecha_actual <= v_fecha_fin LOOP
        INSERT INTO tomas (idmedxuser, tomado, adquired, created_at)
        VALUES (p_medxuser_id, FALSE, v_fecha_actual, NOW());
        v_fecha_actual := v_fecha_actual + v_delta;
    END LOOP;
END;
$$ LANGUAGE plpgsql;

INSERT INTO unidades (nombre, abreviatura) VALUES
    ('miligramos', 'mg'),
    ('gramos', 'g'),
    ('mililitros', 'ml'),
    ('litros', 'L'),
    ('tabletas', 'tab'),
    ('cápsulas', 'caps'),
    ('gotas', 'gts'),
    ('cucharadas', 'cda'),
    ('cucharaditas', 'cdta'),
    ('unidades internacionales', 'UI'),
    ('microgramos', 'mcg'),
    ('onzas', 'oz')
ON CONFLICT (nombre) DO NOTHING;

INSERT INTO medicamentos (nombre) VALUES
    ('Paracetamol'),
    ('Ibuprofeno'),
    ('Amoxicilina'),
    ('Aspirina'),
    ('Omeprazol'),
    ('Loratadina'),
    ('Metformina'),
    ('Atorvastatina'),
    ('Losartán'),
    ('Enalapril'),
    ('Diclofenaco'),
    ('Cetirizina'),
    ('Azitromicina'),
    ('Ciprofloxacino'),
    ('Ranitidina'),
    ('Clonazepam'),
    ('Alprazolam'),
    ('Fluoxetina'),
    ('Sertralina'),
    ('Salbutamol')
ON CONFLICT (nombre) DO NOTHING;

INSERT INTO especialidades (nombre) VALUES
    ('Medicina General'),
    ('Cardiología'),
    ('Dermatología'),
    ('Pediatría'),
    ('Ginecología'),
    ('Oftalmología'),
    ('Traumatología'),
    ('Psiquiatría'),
    ('Neurología'),
    ('Endocrinología'),
    ('Gastroenterología'),
    ('Urología'),
    ('Otorrinolaringología'),
    ('Neumología'),
    ('Nefrología')
ON CONFLICT DO NOTHING;

INSERT INTO clinicas (nombre, ciudad, direccion) VALUES
    ('Hospital Central', 'Lima', 'Av. Principal 123'),
    ('Clínica del Sol', 'Lima', 'Jr. Los Olivos 456'),
    ('Hospital Regional', 'Arequipa', 'Av. Ejército 789'),
    ('Clínica San Pablo', 'Lima', 'Av. El Golf 321'),
    ('Hospital Rebagliati', 'Lima', 'Av. Rebagliati 654')
ON CONFLICT DO NOTHING;

INSERT INTO doctores (nombre, clinica_id, especialidad_id) VALUES
    ('Dr. Juan García', 1, 2),
    ('Dra. María López', 1, 1),
    ('Dr. Carlos Pérez', 2, 3),
    ('Dra. Ana Martínez', 2, 5),
    ('Dr. Luis Rodríguez', 3, 7)
ON CONFLICT DO NOTHING;

INSERT INTO clinic_specialty (clinic_id, specialty_id) VALUES
    (1, 1), (1, 2), (1, 4),
    (2, 1), (2, 3), (2, 5),
    (3, 1), (3, 7), (3, 9)
ON CONFLICT DO NOTHING;

DO $$
BEGIN
    RAISE NOTICE 'Base de datos MimedicApp creada.';
END $$;
